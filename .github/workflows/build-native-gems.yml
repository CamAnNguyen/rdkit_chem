# Build and publish pre-compiled native gems for multiple platforms
# Triggered on version tags (v*) or manual workflow dispatch

name: Build Native Gems

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      skip_publish:
        description: 'Skip publishing to RubyGems'
        required: false
        default: false
        type: boolean

env:
  # RDKit commit to build against
  RDKIT_COMMIT: c2e48f41d88ddc15c6e1f818d1c4ced70b7f20d1

jobs:
  # ===========================================================================
  # Build Linux gems directly on Ubuntu runners (not rake-compiler-dock)
  # ===========================================================================
  build-linux:
    name: Build Linux (Ruby ${{ matrix.ruby }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        ruby:
          - '3.1'
          - '3.2'
          - '3.3'
          - '3.4'
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            libboost-all-dev \
            libeigen3-dev \
            swig \
            libfreetype6-dev \
            libpng-dev \
            zlib1g-dev \
            libsqlite3-dev \
            patchelf
      
      - name: Build RDKit and extension
        run: |
          cd ext/rdkit_chem && ruby extconf.rb
        timeout-minutes: 45
      
      - name: Repair libraries (bundle deps, fix RPATH)
        run: |
          rake repair
      
      - name: Build native gem
        run: |
          rake build_native
      
      - name: Test native loading
        run: |
          rake test_native
      
      - name: Upload gem artifact
        uses: actions/upload-artifact@v4
        with:
          name: gem-x86_64-linux-ruby${{ matrix.ruby }}
          path: '*.gem'
          if-no-files-found: error

  # ===========================================================================
  # Build macOS gems natively on GitHub runners
  # ===========================================================================
  build-macos:
    name: Build macOS (${{ matrix.arch }}, Ruby ${{ matrix.ruby }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15
            arch: arm64-darwin
            ruby: '3.1'
          - runner: macos-15
            arch: arm64-darwin
            ruby: '3.2'
          - runner: macos-15
            arch: arm64-darwin
            ruby: '3.3'
          - runner: macos-15
            arch: arm64-darwin
            ruby: '3.4'
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
      
      - name: Install dependencies
        run: |
          brew install cmake boost eigen swig freetype libpng
      
      - name: Build RDKit
        run: |
          cd ext/rdkit_chem && ruby extconf.rb
        timeout-minutes: 45
      
      - name: Repair libraries (install_name_tool)
        run: |
          rake repair_macos

      - name: Test native loading
        run: |
          rake test_native

      - name: Build native gem
        run: |
          rake build_native

      - name: Upload gem artifact
        uses: actions/upload-artifact@v4
        with:
          name: gem-${{ matrix.arch }}-ruby${{ matrix.ruby }}
          path: '*.gem'
          if-no-files-found: error

  # ===========================================================================
  # Test gems on multiple platforms
  # ===========================================================================
  test:
    name: Test (${{ matrix.os }}, Ruby ${{ matrix.ruby }})
    needs: [build-linux, build-macos]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux tests
          - os: ubuntu-latest
            ruby: '3.1'
            artifact: gem-x86_64-linux-ruby3.1
          - os: ubuntu-latest
            ruby: '3.2'
            artifact: gem-x86_64-linux-ruby3.2
          - os: ubuntu-latest
            ruby: '3.3'
            artifact: gem-x86_64-linux-ruby3.3
          - os: ubuntu-latest
            ruby: '3.4'
            artifact: gem-x86_64-linux-ruby3.4
          - os: ubuntu-24.04
            ruby: '3.1'
            artifact: gem-x86_64-linux-ruby3.1
          - os: ubuntu-24.04
            ruby: '3.2'
            artifact: gem-x86_64-linux-ruby3.2
          - os: ubuntu-24.04
            ruby: '3.3'
            artifact: gem-x86_64-linux-ruby3.3
          - os: ubuntu-24.04
            ruby: '3.4'
            artifact: gem-x86_64-linux-ruby3.4
          # macOS tests
          - os: macos-15
            ruby: '3.1'
            artifact: gem-arm64-darwin-ruby3.1
          - os: macos-15
            ruby: '3.2'
            artifact: gem-arm64-darwin-ruby3.2
          - os: macos-15
            ruby: '3.3'
            artifact: gem-arm64-darwin-ruby3.3
          - os: macos-15
            ruby: '3.4'
            artifact: gem-arm64-darwin-ruby3.4
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
      
      - name: Download gem artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
      
      - name: List available gems
        run: ls -la *.gem || echo "No gems found"
      
      - name: Install gem
        run: |
          gem install *.gem --local
        shell: bash
      
      - name: Test 1 - Basic load test
        run: |
          ruby -e "require 'rdkit_chem'; puts 'Loaded RDKitChem version: ' + RDKitChem::VERSION"
        shell: bash
      
      - name: Test 2 - Smoke test (core functionality)
        run: |
          ruby -e "
            require 'rdkit_chem'
            
            # Test SMILES parsing
            mol = RDKitChem.smiles_to_mol('CCO')
            raise 'SMILES parse failed' unless mol
            
            # Test atom count
            raise 'Atom count wrong: expected 3' unless mol.get_num_atoms == 3
            
            # Test bond count
            raise 'Bond count wrong: expected 2' unless mol.get_num_bonds == 2
            
            # Test mol block generation
            molblock = RDKitChem.mol_to_mol_block(mol)
            raise 'MolBlock generation failed' if molblock.nil? || molblock.empty?
            
            # Test SMILES round-trip
            smiles = RDKitChem.mol_to_smiles(mol)
            raise 'SMILES generation failed' if smiles.nil? || smiles.empty?
            
            puts 'All smoke tests passed!'
          "
        shell: bash
      
      - name: Test 3 - Full test suite
        run: |
          bundle install || true
          rake test || echo "Test suite not available"
        shell: bash

  # ===========================================================================
  # Publish gems to RubyGems
  # ===========================================================================
  publish:
    name: Publish to RubyGems
    needs: test
    if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.skip_publish != 'true'
    runs-on: ubuntu-latest
    environment: rubygems
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
      
      - name: Download all gem artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gem-*
          merge-multiple: true
      
      - name: Build source gem
        run: |
          gem build rdkit_chem.gemspec
      
      - name: List gems to publish
        run: |
          echo "Gems to publish:"
          ls -la *.gem
      
      - name: Setup RubyGems credentials
        run: |
          mkdir -p ~/.gem
          echo ":rubygems_api_key: ${{ secrets.RUBYGEMS_API_KEY }}" > ~/.gem/credentials
          chmod 600 ~/.gem/credentials
      
      - name: Publish gems
        run: |
          for gem in *.gem; do
            echo "Publishing $gem..."
            gem push "$gem" || echo "Failed to push $gem (may already exist)"
          done
